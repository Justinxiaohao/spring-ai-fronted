<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评论API测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>评论API测试工具</h1>
    
    <div class="test-section">
        <h3>1. 测试获取节目评论</h3>
        <input type="number" id="programId" placeholder="节目ID (例如: 1)" value="1">
        <button onclick="testGetComments()">获取评论</button>
        <div id="commentsResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. 测试发表评论</h3>
        <input type="text" id="userEmail" placeholder="用户邮箱" value="">
        <input type="number" id="postProgramId" placeholder="节目ID" value="1">
        <textarea id="commentContent" placeholder="评论内容" rows="3"></textarea>
        <button onclick="testPostComment()">发表评论</button>
        <div id="postResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. 测试获取用户评论</h3>
        <input type="text" id="getUserEmail" placeholder="用户邮箱" value="">
        <button onclick="testGetUserComments()">获取用户评论</button>
        <div id="userCommentsResult" class="result"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080';

        async function request(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            try {
                console.log('请求URL:', url);
                console.log('请求选项:', defaultOptions);
                
                const response = await fetch(url, defaultOptions);
                const data = await response.json();
                
                console.log('响应状态:', response.status);
                console.log('响应数据:', data);
                
                return {
                    success: response.ok,
                    status: response.status,
                    data: data
                };
            } catch (error) {
                console.error('请求失败:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        async function testGetComments() {
            const programId = document.getElementById('programId').value;
            const resultDiv = document.getElementById('commentsResult');
            
            if (!programId) {
                resultDiv.textContent = '请输入节目ID';
                return;
            }

            resultDiv.textContent = '正在获取评论...';
            
            const result = await request(`/api/programs/${programId}/comments?page=1&limit=10`);
            resultDiv.textContent = JSON.stringify(result, null, 2);
        }

        async function testPostComment() {
            const userEmail = document.getElementById('userEmail').value;
            const programId = document.getElementById('postProgramId').value;
            const content = document.getElementById('commentContent').value;
            const resultDiv = document.getElementById('postResult');
            
            if (!userEmail || !programId || !content) {
                resultDiv.textContent = '请填写所有字段';
                return;
            }

            resultDiv.textContent = '正在发表评论...';
            
            const result = await request(`/api/programs/${programId}/comments`, {
                method: 'POST',
                headers: {
                    'User-Email': userEmail
                },
                body: JSON.stringify({
                    content: content
                })
            });
            
            resultDiv.textContent = JSON.stringify(result, null, 2);
        }

        async function testGetUserComments() {
            const userEmail = document.getElementById('getUserEmail').value;
            const resultDiv = document.getElementById('userCommentsResult');
            
            if (!userEmail) {
                resultDiv.textContent = '请输入用户邮箱';
                return;
            }

            resultDiv.textContent = '正在获取用户评论...';
            
            const result = await request('/api/me/comments?page=1&limit=10', {
                headers: {
                    'User-Email': userEmail
                }
            });
            
            resultDiv.textContent = JSON.stringify(result, null, 2);
        }

        // 页面加载时设置默认邮箱
        window.onload = function() {
            const defaultEmail = localStorage.getItem('userEmail') || 'test@example.com';
            document.getElementById('userEmail').value = defaultEmail;
            document.getElementById('getUserEmail').value = defaultEmail;
        };
    </script>
</body>
</html>
